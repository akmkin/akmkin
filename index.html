<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Card</title>
	</head>
	<body>
	<script src="https://vk.com/js/api/xd_connection.js?2"  type="text/javascript"></script>
	<script src="https://akmkin.github.io/akmkin/js/jquery.js"></script>
	<script src="https://akmkin.github.io/akmkin/js/jcanvas.js"></script>

	<script type="text/javascript"> 
		window.name = 'fXD';
		var ststus = false;
		$(document).ready(function(){  VK.init(function() { 
		     console.log('OKdsa');
		     status = true;
		     VK.api("users.get", {}, function (data) {
				console.log(data);
			});
		  }, function() { 
		     console.log('Err');
		}, '5.69')}); 
	</script>
	<!-- <div align="center"> -->
		<canvas id='card' height='600' width='800' style="border:1px solid black;background:#000;">Обновите браузер</canvas>
	<!-- </div> -->
	<script>
 
		kol = [
			//Image, adress, match, mast, number, x, y, on_field
			[new Image(),	'1p.png', 		1,		1, 		1,		0,		0,		0],
			[new Image(),	'2p.png', 		2,		1, 		2,		0,		0,		0],
			[new Image(),	'3p.png', 		3,		1, 		3,		0,		0,		0],
			[new Image(),	'4p.png', 		4,		1, 		4,		0,		0,		0],
			[new Image(),	'5p.png', 		5,		1, 		5,		0,		0,		0],
			[new Image(),	'6p.png', 		6,		1, 		6,		0,		0,		0],
			[new Image(),	'7p.png', 		7,		1, 		7,		0,		0,		0],
			[new Image(),	'8p.png', 		8,		1, 		8,		0,		0,		0],
			[new Image(),	'9p.png', 		9,		1, 		9,		0,		0,		0],
			[new Image(),	'10p.png', 		10,		1, 		10,		0,		0,		0],
			[new Image(),	'11p.png', 		11,		1, 		11,		0,		0,		0],
			[new Image(),	'12p.png', 		12,		1, 		12,		0,		0,		0],
			[new Image(),	'13p.png', 		13,		1, 		13,		0,		0,		0],
			[new Image(),	'1t.png', 		1,		2, 		14,		0,		0,		0],
			[new Image(),	'2t.png', 		2,		2, 		15,		0,		0,		0],
			[new Image(),	'3t.png', 		3,		2, 		16,		0,		0,		0],
			[new Image(),	'4t.png', 		4,		2, 		17,		0,		0,		0],
			[new Image(),	'5t.png', 		5,		2, 		18,		0,		0,		0],
			[new Image(),	'6t.png', 		6,		2, 		19,		0,		0,		0],
			[new Image(),	'7t.png', 		7,		2, 		20,		0,		0,		0],
			[new Image(),	'8t.png', 		8,		2, 		21,		0,		0,		0],
			[new Image(),	'9t.png', 		9,		2, 		22,		0,		0,		0],
			[new Image(),	'10t.png', 		10,		2, 		23,		0,		0,		0],
			[new Image(),	'11t.png', 		11,		2, 		24,		0,		0,		0],
			[new Image(),	'12t.png', 		12,		2, 		25,		0,		0,		0],
			[new Image(),	'13t.png', 		13,		2, 		26,		0,		0,		0],
			[new Image(),	'1b.png', 		1,		3, 		27,		0,		0,		0],
			[new Image(),	'2b.png', 		2,		3, 		28,		0,		0,		0],
			[new Image(),	'3b.png', 		3,		3, 		29,		0,		0,		0],
			[new Image(),	'4b.png', 		4,		3, 		30,		0,		0,		0],
			[new Image(),	'5b.png', 		5,		3, 		31,		0,		0,		0],
			[new Image(),	'6b.png', 		6,		3, 		32,		0,		0,		0],
			[new Image(),	'7b.png', 		7,		3, 		33,		0,		0,		0],
			[new Image(),	'8b.png', 		8,		3, 		34,		0,		0,		0],
			[new Image(),	'9b.png', 		9,		3, 		35,		0,		0,		0],
			[new Image(),	'10b.png', 		10,		3, 		36,		0,		0,		0],
			[new Image(),	'11b.png', 		11,		3, 		37,		0,		0,		0],
			[new Image(),	'12b.png', 		12,		3, 		38,		0,		0,		0],
			[new Image(),	'13b.png', 		13,		3, 		39,		0,		0,		0],
			[new Image(),	'1c.png', 		1,		4, 		40,		0,		0,		0],
			[new Image(),	'2c.png', 		2,		4, 		41,		0,		0,		0],
			[new Image(),	'3c.png', 		3,		4, 		42,		0,		0,		0],
			[new Image(),	'4c.png', 		4,		4, 		43,		0,		0,		0],
			[new Image(),	'5c.png', 		5,		4, 		44,		0,		0,		0],
			[new Image(),	'6c.png', 		6,		4, 		45,		0,		0,		0],
			[new Image(),	'7c.png', 		7,		4, 		46,		0,		0,		0],
			[new Image(),	'8c.png', 		8,		4, 		47,		0,		0,		0],
			[new Image(),	'9c.png', 		9,		4, 		48,		0,		0,		0],
			[new Image(),	'10c.png', 		10,		4, 		49,		0,		0,		0],
			[new Image(),	'11c.png', 		11,		4, 		50,		0,		0,		0],
			[new Image(),	'12c.png', 		12,		4, 		51,		0,		0,		0],
			[new Image(),	'13c.png', 		13,		4, 		52,		0,		0,		0],
			// [new Image(),	'j1.png', 		14,		0, 		52,		0,		0,		0],
			// [new Image(),	'j2.png', 		15,		0, 		53,		0,		0,		0]
		];

		var $myCanvas = $('#card');

		x = 0;
		y = 0;

		shuffle(kol);

		var p1_cards = [];
		var p2_cards = [];

		var p1_i=0;
		var p2_i=0;
		var index = 0;

		p1_table = [];
		p2_table = [];
		bank_table = [];


		//main
		kol.forEach(function(entry, i) {
			if(entry[3] == 3 || entry[3] == 4)
			{
				p1_cards[p1_i] = entry;
				if(p1_i < 4)
					p1_cards[p1_i][7] = 1;
				p1_i++;
			}
			else{
				p2_cards[p2_i] = entry;
				if(p2_i < 4)
					p2_cards[p2_i][7] = 1;
				p2_i++;
			}
		});

		function check_left(layer, x){

			// console.log($myCanvas.getLayer(bank_table[0]).data.match + ' ' + $myCanvas.getLayer(bank_table[1]).data.match + ' ' + layer.data.match);

			if(bank_table[0] == layer.name || bank_table[1] == layer.name )
				return x;
			if( x == 330 )
			{
				if($myCanvas.getLayer(bank_table[1]).data.match-1 == layer.data.match 
				   || $myCanvas.getLayer(bank_table[1]).data.match+1 == layer.data.match 
				   || ($myCanvas.getLayer(bank_table[1]).data.match == 13 && layer.data.match == 1)
				   || ($myCanvas.getLayer(bank_table[1]).data.match == 1 && layer.data.match == 13 ) )
				{
					return 470;
				}
				else 
				{
					return 330;
				}
			}
			if( x == 470 )
			{
				if($myCanvas.getLayer(bank_table[0]).data.match-1 == layer.data.match 
				   || $myCanvas.getLayer(bank_table[0]).data.match+1 == layer.data.match 
				   || ($myCanvas.getLayer(bank_table[0]).data.match == 13 && layer.data.match == 1)
				   || ($myCanvas.getLayer(bank_table[0]).data.match == 1 && layer.data.match == 13 ) )
				{
					return 330;
				}
				else
				{
					return 470;
				}
			}
		}

		move = 55;





		function check_real_step(name, bank){
			layer = $myCanvas.getLayer(name);
			if($myCanvas.getLayer(bank).data.match-1 == layer.data.match 
			   || $myCanvas.getLayer(bank).data.match+1 == layer.data.match 
			   || ($myCanvas.getLayer(bank).data.match == 13 && layer.data.match == 1)
			   || ($myCanvas.getLayer(bank).data.match == 1 && layer.data.match == 13 ) )
				return true;
			return false;
		}






		function step(name, x, y, time, old_x, old_y){
			$myCanvas.setLayer(name, {index:0});
			$myCanvas.moveLayer(name, 55).drawLayers();
			x = check_left($myCanvas.getLayer(name), x);
			if(x == 330)
				res = bank_table[0];
			else 
				res = bank_table[1];
			// console.log(x);
			$myCanvas.animateLayer(
			    name, 
			    {
					x: function(layer) {
						return x;
					},
					y: function(layer) {
						return y;
					},
				},
				time, 
				'swing', 
				function(layer){
					if(!check_real_step(name, res)){
						$myCanvas.animateLayer(
						    name, 
						    {
								x: function(layer) {
									return old_x;
								},
								y: function(layer) {
									return old_y;
								},
							},
							time
						);
					}
					else{
						if(x == 330)
							bank_table[0] = name;
						else 
							bank_table[1] = name;
						if(layer.data.player == 1){
							rewr_an1(p1_index, layer.data.index);
							p1_index++;
						}
						else if(layer.data.player == 2){
							rewr_an2(p2_index, layer.data.index);
							p2_index++;
						}
						rewrite_speed();
					}
				}
			);
			
		}


		var bank = [];

		var p1_index = 4;
		var p2_index = 4;


		$myCanvas.animateLayer;
		start_speed(p1_cards, p2_cards, bank);

		function start_speed(p1_cards, p2_cards, bank)
		{
			p1_cards.reverse();
			p2_cards.reverse();

			p1_cards.forEach(function(entry, i) {
				$myCanvas.addLayer({
					layer: true,
					name: entry[1],
					type: 'image',
					visible: false,
					source: '/akmkin/img/kol/'+entry[1],
					x: 60, y: 82,
					data: {clickable: false, oldx:0, oldy:0, match: entry[2]},
					click: function(layer){step(layer.name, 330, 300, 300, layer.data.oldx, layer.data.oldy);}
				})
				.drawLayers();
			});

			p2_cards.forEach(function(entry, i) {
				$myCanvas.addLayer({
					layer: true,
					name: entry[1],
					type: 'image',
					visible: false,
					source: '/akmkin/img/kol/'+entry[1],
					x: 740, y: 518,
					data: {clickable: false, oldx:0, oldy:0, match: entry[2]},
					click: function(layer){step(layer.name, 470, 300, 300, layer.data.oldx, layer.data.oldy);}
				})
				.drawLayers();
			});
			
			p1_cards.reverse();
			p2_cards.reverse();

			x1 = 580;
			y1 = 82;
			x2 = 220;
			y2 = 518;

			time = 700;

			for( i = 0, j = 0; i < 1; i++)
			{
				$myCanvas.setLayer(p1_cards[0][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p2_cards[0][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p1_cards[0][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p1_cards[1][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p2_cards[1][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p1_cards[2][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p2_cards[2][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p1_cards[3][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p2_cards[3][1], {
				  visible: true,
				  data: {clickable: true},
				}).setLayer(p1_cards[4][1], {
				  visible: true,
				}).setLayer(p2_cards[4][1], {
				  visible: true,
				})
				.drawLayers();
				an1(i);
				an2(j);

				function an1(ii){
					$myCanvas.setLayer(p1_cards[ii][1], {
						data: {oldx:x1, oldy:y1, match: p1_cards[ii][2], index: ii, player: 1},
					});
					$myCanvas.animateLayer(p1_cards[ii][1], {
						  x: function(layer) {
						    return x1;
						  }
						}, time, 'swing', function(){ time -= 50; x1 -= 120; 
							if(ii+1 < 4) {
								p1_table[ii] = p1_cards[ii][1];
								an1(++ii);
							}
							else {bank_table[0] = p1_cards[ii+1][1]; step(p1_cards[ii+1][1], 330, 300, 300);return}
							return;});
				}
				
				function an2(jj){
					$myCanvas.setLayer(p2_cards[jj][1], {
						data: {oldx:x2, oldy:y2, match: p2_cards[jj][2], index:jj, player: 2},
					});
					$myCanvas.animateLayer(p2_cards[jj][1], {
						  x: function(layer) {
						    return x2;
						  }
						}, time, 'swing', function(){ time -= 50; x2 += 120; 
							if(jj+1 < 4){
								p2_table[jj] = p2_cards[jj][1];
								an2(++jj);
							}
							else {bank_table[1] = p2_cards[jj+1][1]; step(p2_cards[jj+1][1], 470, 300, 300);return}
							return;});
				}

				// x1 += 120;
				// x2 += 120;
				$myCanvas.drawLayers();
			}


			$myCanvas
			//rub1
			.addLayer({
			  layer: true,
			  name: 'rub1',
			  type: 'image',
			  source: '/akmkin/img/kol/rub.png',
			  x: 60, y: 82,
			})
			//rub2
			.addLayer({
			  layer: true,
			  name: 'rub2',
			  type: 'image',
			  source: '/akmkin/img/kol/rub.png',
			  x: 740, y: 518,
			})
			.drawLayers();
		}








		function rewr_an1(ii, index){
			if(index == 0)
			{
				x1 = 580;
				time = 700;
			}
			if(index == 1)
			{
				x1 = 460;
				time = 600;
			}
			if(index == 2)
			{
				x1 = 340;
				time = 500;
			}
			if(index == 3)
			{
				x1 = 220;
				time = 400;
			}
			console.log(index);

			y1 = 82;
			try{
				$myCanvas.setLayer(p1_cards[ii+1][1], {
					visible: true,
					data: {oldx:x1, oldy:y1, match: p1_cards[ii+1][2], index: index, player: 1},
				});
				$myCanvas.animateLayer(p1_cards[ii+1][1], {
					  x: function(layer) {
					    return x1;
					  }
					}, time, 'swing');
			}
			catch (exception_var) {
				if(p1_index == 25 || p2_index == 25)
				{
					$('canvas').removeLayers();
					p1_index = p2_index = 4;
					start_speed(p1_cards, p2_cards, bank);
				} 
			}
		}
		
		function rewr_an2(jj, index2){
			if(index2 == 3)
			{
				x2 = 580;
				time = 400;
			}
			if(index2 == 2)
			{
				x2 = 460;
				time = 500;
			}
			if(index2 == 1)
			{
				x2 = 340;
				time = 600;
			}
			if(index2 == 0)
			{
				x2 = 220;
				time = 700;
			}
			console.log(index2);

			y2 = 518;

			try{
				$myCanvas.setLayer(p2_cards[jj+1][1], {
					visible: true,
					data: {oldx:x2, oldy:y2, match: p2_cards[jj+1][2], index:index2, player: 2},
				});
				$myCanvas.animateLayer(p2_cards[jj+1][1], {
					  x: function(layer) {
					    return x2;
					  }
					}, time, 'swing');
			}
			catch (exception_var) {
				$('canvas').removeLayers();
				start_speed(p1_cards, p2_cards, bank);
			}
		}




		function rewrite_speed(){
			// start_speed(p1_cards, p2_cards, bank);
			// $myCanvas.drawLayers();
		}

		function shuffle(array) {
			var currentIndex = array.length, temporaryValue, randomIndex;
			while (0 !== currentIndex) {
				randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex -= 1;
				temporaryValue = array[currentIndex];
				array[currentIndex] = array[randomIndex];
				array[randomIndex] = temporaryValue;
			}
			return array;
		}





    </script>
  </body>
</html>